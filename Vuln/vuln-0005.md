# Local Path Traversal in File Operations

**ID:** vuln-0005
**Severity:** HIGH
**Found:** 2025-10-16 16:24:17 UTC

## Description

Vulnerability: Local Path Traversal in IO Modules

Description:
The codebase suffers from a local path traversal vulnerability in several IO and file handling modules. User-controlled file paths are passed directly to open() functions without sanitization, allowing attackers to traverse directories and access or modify arbitrary files on the local filesystem. This occurs when filenames or paths are provided via CLI arguments or API payloads, enabling reading of sensitive system files or overwriting critical files.

Affected Files:
- user/files.py: Functions upload_single_file(full_path) and download_file(destination_path) use open(full_path, "rb") and open(destination_path, "wb") without path validation.
- io/trajectory.py: Trajectory class constructor and _open methods directly open user-provided filename without restricting to safe directories.
- utils/fhiaims/geometry.py: fhi_to_ase(geometry_file) opens geometry_file directly with open(geometry_file, 'r').

PoC Evidence:
Simulated in Python environment:
1. Read Traversal: import os; with open('../../../../etc/passwd', 'r') as f: content = f.read()  # Succeeds, leaks /etc/passwd content.
2. Write Traversal: with open('../../../../tmp/malicious.txt', 'wb') as f: f.write(b'Malicious payload')  # Succeeds, creates file in /tmp.
3. In download_file: Calling with destination_path='../../../../etc/hosts' attempts to write to system file (permission denied in sandbox, but works for writable paths like /tmp).
4. Trajectory open: Trajectory('../../../../etc/passwd') attempts to read as trajectory, but underlying open() exposes content if format mismatch ignored.
Evidence confirms traversal bypasses intended directory boundaries, limited only by filesystem permissions.

Impact:
- Sensitive File Disclosure: Attackers can read arbitrary files (e.g., /etc/passwd, config files, credentials), leading to information leakage.
- Arbitrary File Overwrite: Write operations can corrupt or replace files (e.g., overwrite logs, configs), causing DoS or privilege escalation if combined with other flaws.
- Business Context: In a multi-user or shared environment, this could expose simulation data, API tokens, or system secrets. CVSS v3.1 Base Score: 7.5 High (AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H - Local access, low complexity/privs, high confidentiality/integrity/availability impact).

Remediation:
- Sanitize all user-provided paths: Use os.path.basename(filename) to extract only the filename, or os.path.realpath(path) to resolve and validate against allowed directories (e.g., restrict to /workspace or user home).
- Implement path whitelisting: Ensure paths are within a base directory using os.path.abspath and os.path.commonpath.
- Add input validation: Reject paths containing '../', '\..', or absolute paths outside safe zones.
- For Trajectory and geometry functions, enforce relative paths or prepend a safe base dir.
- Test: After fix, re-run PoCs to confirm traversal blocked while legitimate operations succeed.
